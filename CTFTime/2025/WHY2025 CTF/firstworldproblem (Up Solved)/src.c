/* This file was generated by the Hex-Rays decompiler version 9.1.0.250226.
   Copyright (c) 2007-2021 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

__int64 __fastcall sub_10(__int64 a1, __int64 a2, size_t a3);
__int64 __fastcall sub_70(__int64 a1, __int64 a2, size_t a3);
__int64 __fastcall sub_F0(); // weak
__int64 __fastcall sub_120(__int64 a1, __int64 a2, unsigned __int64 a3);
__int64 __fastcall sub_1A0(__int64 a1, size_t a2);
__int64 _pfx_init_module(); // weak
__int64 init_module();
__int64 _pfx_cleanup_module(); // weak
__int64 cleanup_module();
// __int64 __fastcall _check_object_size(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall copy_from_user(_QWORD, _QWORD, _QWORD); weak
// int snprintf(char *s, size_t maxlen, const char *format, ...);
// __int64 stackleak_track_stack(void); weak
// __int64 __fastcall class_destroy(_QWORD); weak
// __int64 __fastcall printk(_QWORD); weak
// size_t strnlen(const char *string, size_t maxlen);
// __int64 __fastcall device_create(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall class_create(_QWORD); weak
// __int64 __fastcall class_unregister(_QWORD); weak
// __int64 __fastcall _fortify_panic(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall copy_to_user(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall _register_chrdev(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall device_destroy(_QWORD, _QWORD); weak
// __int64 __fastcall _unregister_chrdev(_QWORD, _QWORD, _QWORD, _QWORD); weak

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_510; // weak
_UNKNOWN unk_53A; // weak
_UNKNOWN unk_540; // weak
_UNKNOWN unk_568; // weak
_UNKNOWN unk_588; // weak
_UNKNOWN unk_5C3; // weak
_UNKNOWN unk_5D6; // weak
_UNKNOWN _start_alloc_tags; // weak
char format[512]; // idb
__int64 qword_1580; // weak
__int64 qword_1588; // weak
int dword_1590; // weak
// extern _UNKNOWN latent_entropy; weak


//----- (0000000000000010) ----------------------------------------------------
__int64 __fastcall sub_10(__int64 a1, __int64 a2, size_t a3)
{
  return sub_1A0(a2, a3);
}

//----- (0000000000000070) ----------------------------------------------------
__int64 __fastcall sub_70(__int64 a1, __int64 a2, size_t a3)
{
  return sub_10(a1, a2, a3);
}

//----- (0000000000000120) ----------------------------------------------------
__int64 __fastcall write(__int64 a1, __int64 a2, unsigned __int64 a3)
{
  __int64 v3; // rax
  __int64 v4; // rbx

  memset(format, 0, sizeof(format));
  v3 = 512;
  if ( a3 <= 0x200 )
    v3 = a3;
  v4 = v3;
  _check_object_size(format, v3, 0);
  if ( copy_from_user(format, a2, v4) == -1 )
    return -1;
  return v4;
}
// 1598: using guessed type __int64 __fastcall _check_object_size(_QWORD, _QWORD, _QWORD);
// 15A0: using guessed type __int64 __fastcall copy_from_user(_QWORD, _QWORD, _QWORD);

//----- (00000000000001A0) ----------------------------------------------------
__int64 __fastcall read(__int64 a1, size_t a2)
{
  size_t v2; // rbx
  size_t v3; // rax
  char v5[512]; // [rsp+0h] [rbp-228h] BYREF
  unsigned __int64 v6; // [rsp+200h] [rbp-28h]

  v2 = a2;
  v6 = __readgsqword(0x28u);
  stackleak_track_stack();
  memset(v5, 0, sizeof(v5));
  snprintf(v5, 0x200u, format);
  memset(format, 0, sizeof(format));
  v3 = strnlen(v5, 0x200u);
  if ( v3 > 0x200 )
  {
LABEL_9:
    _fortify_panic(2, 512, v3 + 1);
    JUMPOUT(0x504);
  }
  if ( v3 == 512 )
  {
    v3 = _fortify_panic(4, 512, 513);
    goto LABEL_9;
  }
  if ( v3 <= a2 )
    v2 = v3;
  _check_object_size(v5, v2, 1);
  if ( copy_to_user(a1, v5, v2) == -1 )
    return -1;
  return v2;
}
// 4FF: control flows out of bounds to 504
// 1598: using guessed type __int64 __fastcall _check_object_size(_QWORD, _QWORD, _QWORD);
// 15B0: using guessed type __int64 stackleak_track_stack(void);
// 15F0: using guessed type __int64 __fastcall _fortify_panic(_QWORD, _QWORD, _QWORD);
// 1600: using guessed type __int64 __fastcall copy_to_user(_QWORD, _QWORD, _QWORD);

//----- (00000000000002B0) ----------------------------------------------------
__int64 _pfx_init_module()
{
  return init_module();
}
// 2B0: using guessed type __int64 _pfx_init_module();

//----- (00000000000002C0) ----------------------------------------------------
__int64 init_module()
{
  unsigned __int64 v0; // rbx
  unsigned __int64 v1; // rbx
  __int64 result; // rax
  __int64 v3; // rbx
  unsigned __int64 v4; // rdi
  int v5; // eax
  __int64 v6; // rbx
  __int64 savedregs; // [rsp+8h] [rbp+0h] BYREF

  v0 = (unsigned __int64)&savedregs ^ latent_entropy ^ 0x26A565D6E6F128F1LL;
  dword_1590 = _register_chrdev(0, 0, 256, "echo", &_start_alloc_tags);
  if ( dword_1590 >= 0 )
  {
    v3 = __ROR8__(v0, 16);
    v4 = class_create(&unk_53A);
    qword_1588 = v4;
    v5 = dword_1590;
    if ( v4 <= 0xFFFFFFFFFFFFF000LL )
    {
      *(_QWORD *)(v4 + 32) = sub_F0;
      v6 = v3 + 0x77C8717E62D0CD1CLL;
      qword_1580 = device_create(v4, 0, (unsigned int)(v5 << 20), 0, "echo");
      if ( (unsigned __int64)qword_1580 <= 0xFFFFFFFFFFFFF000LL )
      {
        v1 = v6 ^ 0x1442D4BBAE759583LL;
        printk(&unk_588);
        printk(&unk_5C3);
        result = 0;
      }
      else
      {
        v1 = __ROR8__(v6, 30);
        class_destroy(qword_1588);
        _unregister_chrdev((unsigned int)dword_1590, 0, 256, "echo");
        printk(&unk_568);
        result = (unsigned int)qword_1580;
      }
    }
    else
    {
      v1 = v3 ^ 0xAA095988E42FF284LL;
      _unregister_chrdev((unsigned int)dword_1590, 0, 256, "echo");
      printk(&unk_540);
      result = (unsigned int)qword_1588;
    }
  }
  else
  {
    v1 = v0 - 0x5A240624700363F1LL;
    printk(&unk_510);
    result = (unsigned int)dword_1590;
  }
  latent_entropy ^= v1 - 0x47BB68920E2F1D8FLL;
  return result;
}
// F0: using guessed type __int64 __fastcall sub_F0();
// 1580: using guessed type __int64 qword_1580;
// 1588: using guessed type __int64 qword_1588;
// 1590: using guessed type int dword_1590;
// 15B8: using guessed type __int64 __fastcall class_destroy(_QWORD);
// 15C0: using guessed type __int64 __fastcall printk(_QWORD);
// 15D8: using guessed type __int64 __fastcall device_create(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 15E0: using guessed type __int64 __fastcall class_create(_QWORD);
// 1608: using guessed type __int64 __fastcall _register_chrdev(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 1620: using guessed type __int64 __fastcall _unregister_chrdev(_QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000000000470) ----------------------------------------------------
__int64 _pfx_cleanup_module()
{
  return cleanup_module();
}
// 470: using guessed type __int64 _pfx_cleanup_module();

//----- (0000000000000480) ----------------------------------------------------
__int64 cleanup_module()
{
  device_destroy(qword_1588, (unsigned int)(dword_1590 << 20));
  class_unregister(qword_1588);
  class_destroy(qword_1588);
  _unregister_chrdev((unsigned int)dword_1590, 0, 256, "echo");
  return printk(&unk_5D6);
}
// 1588: using guessed type __int64 qword_1588;
// 1590: using guessed type int dword_1590;
// 15B8: using guessed type __int64 __fastcall class_destroy(_QWORD);
// 15C0: using guessed type __int64 __fastcall printk(_QWORD);
// 15E8: using guessed type __int64 __fastcall class_unregister(_QWORD);
// 1610: using guessed type __int64 __fastcall device_destroy(_QWORD, _QWORD);
// 1620: using guessed type __int64 __fastcall _unregister_chrdev(_QWORD, _QWORD, _QWORD, _QWORD);

// nfuncs=26 queued=8 decompiled=8 lumina nreq=0 worse=0 better=0
// ALL OK, 8 function(s) have been successfully decompiled
